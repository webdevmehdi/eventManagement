"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-pdf-viewer/core");function n(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var r=n(e),a=function(){return a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},a.apply(this,arguments)},i=function(e){var n=e.getPageIndex,a=e.renderSpinner,i=e.doc,o=r.useState(""),u=o[0],c=o[1],l=t.useIsMounted(),s=r.useRef(),d=t.useIntersectionObserver({onVisibilityChanged:function(e){if(!u&&e.isVisible){var r=d.current;if(r){var a=i.numPages,o=n?n({numPages:a}):0,g=Math.max(0,Math.min(o,a-1));t.getPage(i,g).then((function(e){var t=e.getViewport({scale:1}),n=t.width,a=t.height,i=document.createElement("canvas"),o=i.getContext("2d",{alpha:!1}),u=r.clientWidth,d=r.clientHeight,g=Math.min(u/n,d/a),p=g*n,h=g*a;i.height=h,i.width=p,i.style.opacity="0";var f=e.getViewport({rotation:0,scale:g});s.current=e.render({canvasContext:o,viewport:f}),s.current.promise.then((function(){l.current&&c(i.toDataURL()),i.width=0,i.height=0}),(function(){}))}))}}}});return r.useEffect((function(){return function(){var e;null===(e=s.current)||void 0===e||e.cancel()}}),[]),u?r.createElement("img",{className:"rpv-thumbnail__cover-image","data-testid":"thumbnail__cover-image",src:u}):r.createElement("div",{className:"rpv-thumbnail__cover-loader","data-testid":"thumbnail__cover-loader",ref:d},a?a():r.createElement(t.Spinner,null))},o=function(e){var n=e.getPageIndex,a=e.renderSpinner,o=e.store,u=r.useState(o.get("doc")),c=u[0],l=u[1],s=function(e){l(e)};return r.useEffect((function(){return o.subscribe("doc",s),function(){o.unsubscribe("doc",s)}}),[]),r.createElement("div",{className:"rpv-thumbnail__cover"},c?r.createElement(i,{doc:c,getPageIndex:n,renderSpinner:a}):r.createElement("div",{className:"rpv-thumbnail__cover-loader"},a?a():r.createElement(t.Spinner,null)))},u=function(){return r.createElement(t.Spinner,null)},c=r.createContext({renderSpinner:u}),l=function(e){var n=e.page,a=e.pageHeight,i=e.pageIndex,o=e.pageWidth,u=e.rotation,l=e.thumbnailHeight,s=e.thumbnailWidth,d=e.onRenderCompleted,g=r.useContext(t.LocalizationContext).l10n,p=r.useRef(),h=r.useState(""),f=h[0],m=h[1],b=g&&g.thumbnail?g.thumbnail.thumbnailLabel:"Thumbnail of page {{pageIndex}}";return r.useEffect((function(){var e=p.current;e&&e.cancel();var t=document.createElement("canvas"),r=t.getContext("2d",{alpha:!1}),c=s,l=c/(o/a),g=c/o;t.height=l,t.width=c,t.style.height="".concat(l,"px"),t.style.width="".concat(c,"px");var h=n.getViewport({rotation:u,scale:g});return p.current=n.render({canvasContext:r,viewport:h}),p.current.promise.then((function(){m(t.toDataURL()),d(i)}),(function(){d(i)})),function(){var e;null===(e=p.current)||void 0===e||e.cancel()}}),[u]),f?r.createElement("img",{"aria-label":b.replace("{{pageIndex}}","".concat(i+1)),src:f,height:"".concat(l,"px"),width:"".concat(s,"px")}):r.useContext(c).renderSpinner()},s=function(e){var n=e.doc,a=e.pageHeight,i=e.pageIndex,o=e.pageRotation,u=e.pageWidth,s=e.rotation,d=e.shouldRender,g=e.onRenderCompleted,p=e.onVisibilityChanged,h=r.useState({height:a,page:null,viewportRotation:0,width:u}),f=h[0],m=h[1],b=f.page,v=f.height,P=f.width,_=P/v,E=Math.abs(s+o)%180==0,x=E?100:100/_,R=E?100/_:100;r.useEffect((function(){d&&t.getPage(n,i).then((function(e){var t=e.getViewport({scale:1});m({height:t.height,page:e,viewportRotation:t.rotation,width:t.width})}))}),[d]);var C=(f.viewportRotation+s+o)%360,S=t.useIntersectionObserver({onVisibilityChanged:function(e){p(i,e)}});return r.createElement("div",{className:"rpv-thumbnail__container","data-testid":"thumbnail__container-".concat(i),ref:S,style:{height:"".concat(R,"px"),width:"".concat(x,"px")}},b?r.createElement(l,{page:b,pageHeight:E?v:P,pageIndex:i,pageWidth:E?P:v,rotation:C,thumbnailHeight:R,thumbnailWidth:x,onRenderCompleted:g}):r.useContext(c).renderSpinner())},d=function(e){var n=e.currentPage,a=e.doc,i=e.pagesRotation,o=e.pageHeight,u=e.pageWidth,c=e.renderCurrentPageLabel,l=e.renderThumbnailItem,d=e.rotatedPage,g=e.rotation,p=e.onJumpToPage,h=e.onRotatePage,f=r.useState([]),m=f[0],b=f[1],v=a.numPages,P=a.loadingTask.docId,_=m.length,E=r.useRef(null),x=r.useRef([]),R=r.useState(n),C=R[0],S=R[1],I=r.useContext(t.ThemeContext).direction===t.TextDirection.RightToLeft,w=r.useState(-1),y=w[0],T=w[1],L=t.useIsMounted(),k=r.useRef(!1),H=r.useMemo((function(){return Array(v).fill(0).map((function(e,t){return t}))}),[P]),N=r.useMemo((function(){return t.renderQueueService({doc:a,queueName:"thumbnail-list",priority:999})}),[P]);r.useEffect((function(){a.getPageLabels().then((function(e){L.current&&b(e||[])}))}),[P]);var O=function(){if(E.current){var e=x.current,t=C+1;t<e.length&&(C>=0&&e[C].setAttribute("tabindex","-1"),S(t))}},W=function(){if(E.current){var e=x.current,t=C-1;t>=0&&(C>=0&&e[C].setAttribute("tabindex","-1"),S(t))}},V=function(){C>=0&&C<v&&p(C)};t.useIsomorphicLayoutEffect((function(){var e=E.current;e&&(x.current=Array.from(e.querySelectorAll(".rpv-thumbnail__item")))}),[]),r.useEffect((function(){var e=x.current;if(!(0===e.length||C<0||C>e.length)){var t=e[C];t.setAttribute("tabindex","0"),t.focus()}}),[C]),t.useIsomorphicLayoutEffect((function(){var e=E.current;if(e){var t=e.children;n<t.length&&function(e,t){var n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,r=e.clientHeight,a=t.clientHeight;n<0?t.scrollTop+=n:n+r<=a||(t.scrollTop+=n+r-a)}(t.item(n),e)}}),[n]);var M=r.useCallback((function(e){L.current&&(N.markRendered(e),k.current=!1,A())}),[P]),j=r.useCallback((function(e,t){N.setVisibility(e,t.isVisible?t.ratio:N.OUT_OF_RANGE_VISIBILITY),A()}),[P]),A=r.useCallback((function(){if(!k.current){var e=N.getHighestPriorityPage();e>-1&&(N.markRendering(e),k.current=!0,T(e))}}),[P]);return r.useEffect((function(){d>=0&&(N.markRendering(d),k.current=!0,T(d))}),[P,d]),r.useEffect((function(){return function(){N.cleanup()}}),[P]),r.createElement("div",{ref:E,"data-testid":"thumbnail__list",className:t.classNames({"rpv-thumbnail__list":!0,"rpv-thumbnail__list--rtl":I}),onKeyDown:function(e){switch(e.key){case"ArrowDown":O();break;case"ArrowUp":W();break;case"Enter":V()}}},H.map((function(e){var d="".concat(a.loadingTask.docId,"___").concat(e),f=_===v?m[e]:"".concat(e+1),b=c?c({currentPage:n,pageIndex:e,numPages:v,pageLabel:f}):f,P=i.has(e)?i.get(e):0,E=r.createElement(s,{doc:a,pageHeight:o,pageIndex:e,pageRotation:P,pageWidth:u,rotation:g,shouldRender:y===e,onRenderCompleted:M,onVisibilityChanged:j});return l?l({currentPage:n,key:d,numPages:v,pageIndex:e,renderPageLabel:r.createElement(r.Fragment,null,b),renderPageThumbnail:E,onJumpToPage:function(){return p(e)},onRotatePage:function(t){return h(e,t)}}):r.createElement("div",{key:d},r.createElement("div",{className:t.classNames({"rpv-thumbnail__item":!0,"rpv-thumbnail__item--selected":n===e}),role:"button",tabIndex:n===e?0:-1,onClick:function(){return p(e)}},E),r.createElement("div",{"data-testid":"thumbnail__label-".concat(e),className:"rpv-thumbnail__label"},b))})))},g=function(e){var n=e.renderCurrentPageLabel,a=e.renderThumbnailItem,i=e.store,o=r.useState(i.get("doc")),u=o[0],l=o[1],s=r.useState(i.get("currentPage")||0),g=s[0],p=s[1],h=r.useState(i.get("pageHeight")||0),f=h[0],m=h[1],b=r.useState(i.get("pageWidth")||0),v=b[0],P=b[1],_=r.useState(i.get("rotation")||0),E=_[0],x=_[1],R=r.useState(i.get("pagesRotation")||new Map),C=R[0],S=R[1],I=r.useState(i.get("rotatedPage")||-1),w=I[0],y=I[1],T=function(e){p(e)},L=function(e){l(e)},k=function(e){m(e)},H=function(e){P(e)},N=function(e){x(e)},O=function(e){S(e)},W=function(e){y(e)};return r.useEffect((function(){return i.subscribe("doc",L),i.subscribe("pageHeight",k),i.subscribe("pageWidth",H),i.subscribe("rotatedPage",W),i.subscribe("rotation",N),i.subscribe("pagesRotation",O),function(){i.unsubscribe("doc",L),i.unsubscribe("pageHeight",k),i.unsubscribe("pageWidth",H),i.unsubscribe("rotatedPage",W),i.unsubscribe("rotation",N),i.unsubscribe("pagesRotation",O)}}),[]),t.useIsomorphicLayoutEffect((function(){return i.subscribe("currentPage",T),function(){i.unsubscribe("currentPage",T)}}),[]),u?r.createElement(t.LazyRender,{testId:"thumbnail__list-container",attrs:{className:"rpv-thumbnail__list-container"}},r.createElement(d,{currentPage:g,doc:u,pagesRotation:C,pageHeight:f,pageWidth:v,renderCurrentPageLabel:n,renderThumbnailItem:a,rotatedPage:w,rotation:E,onJumpToPage:function(e){var t=i.get("jumpToPage");t&&t(e)},onRotatePage:function(e,t){i.get("rotatePage")(e,t)}})):r.createElement("div",{"data-testid":"thumbnail-list__loader",className:"rpv-thumbnail__loader"},r.useContext(c).renderSpinner())};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */exports.thumbnailPlugin=function(e){var n=r.useMemo((function(){return t.createStore({rotatePage:function(){}})}),[]),i=r.useState(""),l=i[0],s=i[1];return{install:function(e){n.update("jumpToPage",e.jumpToPage),n.update("rotatePage",e.rotatePage)},onDocumentLoad:function(e){s(e.doc.loadingTask.docId),n.update("doc",e.doc)},onViewerStateChange:function(e){return n.update("currentPage",e.pageIndex),n.update("pagesRotation",e.pagesRotation),n.update("pageHeight",e.pageHeight),n.update("pageWidth",e.pageWidth),n.update("rotation",e.rotation),n.update("rotatedPage",e.rotatedPage),e},Cover:function(t){return r.createElement(o,a({},t,{renderSpinner:null==e?void 0:e.renderSpinner,store:n}))},Thumbnails:r.useCallback((function(t){return r.createElement(c.Provider,{value:{renderSpinner:(null==e?void 0:e.renderSpinner)||u}},r.createElement(g,{renderCurrentPageLabel:null==e?void 0:e.renderCurrentPageLabel,renderThumbnailItem:null==t?void 0:t.renderThumbnailItem,store:n}))}),[l])}};
